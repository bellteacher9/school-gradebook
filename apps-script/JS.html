<script>
  let currentTab = 'welcome';
  let allData = {};

  function checkLogin() {
    const pwd = document.getElementById('admin-pwd').value;
    google.script.run
      .withSuccessHandler(isValid => {
        if (isValid) {
          document.getElementById('login-overlay').style.display = 'none';
          document.getElementById('app-container').style.display = 'flex';
          refreshData();
        } else {
          document.getElementById('login-error').style.display = 'block';
        }
      })
      .withFailureHandler(err => {
        alert("Login Error: " + err.message);
      })
      .validatePassword(pwd);
  }

  function refreshData() {
    const year = document.getElementById('year-select').value;
    document.getElementById('active-year-text').innerText = year || "---";

    if (currentTab === 'welcome') {
      renderCurrentTab();
      return;
    }
    
    document.getElementById('table-container').innerHTML = `<div style="text-align:center; padding:20px;">Fetching ${year} data...</div>`;
    
    google.script.run
      .withSuccessHandler(data => {
        allData = data;
        renderCurrentTab();
      })
      .withFailureHandler(err => {
        logDebug("Fetch Error: " + err.message);
        document.getElementById('table-container').innerHTML = `<div style="color:red; padding:20px;">Error fetching data: ${err.message}</div>`;
      })
      .getAdminData(year);
  }

  function logDebug(msg) {
    const el = document.getElementById('debug-log');
    el.style.display = 'block';
    el.innerHTML += `> ${msg}<br>`;
    el.scrollTop = el.scrollHeight;
  }

  function loadTab(sheetName) {
    currentTab = sheetName;
    const title = document.getElementById('tab-title');
    
    // Update title immediately for better responsiveness
    title.innerText = currentTab.replace('admin_', '').replace('_', ' ').toUpperCase();
    
    // Update Sidebar UI
    document.querySelectorAll('.nav-item').forEach(el => {
      el.classList.remove('active');
      const cleanName = sheetName.replace('admin_', '').replace('_', ' ');
      if(el.innerText.toLowerCase() === cleanName || el.innerText.toLowerCase() === sheetName) {
        el.classList.add('active');
      }
    });

    if (sheetName === 'welcome') {
      renderCurrentTab();
    } else {
      refreshData();
    }
  }

  function renderCurrentTab() {
    const container = document.getElementById('table-container');
    const title = document.getElementById('tab-title');
    const addBtn = document.querySelector('.btn-primary[onclick="openEntryForm()"]');
    
    if (currentTab === 'welcome') {
      title.innerText = "Welcome";
      container.innerHTML = `
        <div style="padding: 20px; text-align: center;">
          <p style="font-size: 1.2rem; color: var(--dark-gray);">
            Welcome. If you haven't done so already, choose the current intake year.
          </p>
          <p style="color: var(--maroon); font-weight: bold; border: 2px solid var(--maroon); padding: 15px; border-radius: 8px;">
            ⚠️ Make sure you choose the correct year because this will affect data for all your students and teachers!
          </p>
        </div>
      `;
      if (addBtn) addBtn.style.display = 'none';
      return;
    }

    if (addBtn) addBtn.style.display = 'block';
    const tabData = allData[currentTab];
    // Title is already set by loadTab

    if (!tabData || tabData.rows.length === 0) {
      container.innerHTML = "<p>No records found for this year.</p>";
      return;
    }

    let html = "<table><thead><tr>";
    tabData.headers.forEach(h => html += `<th>${h}</th>`);
    html += "</tr></thead><tbody>";

    tabData.rows.forEach(row => {
      html += "<tr>";
      row.forEach(cell => html += `<td>${cell || ''}</td>`);
      html += "</tr>";
    });

    html += "</tbody></table>";
    container.innerHTML = html;
  }

  function openEntryForm() {
    const tabData = allData[currentTab];
    const formContent = document.getElementById('modal-form-content');
    const year = document.getElementById('year-select').value;
    
    let html = "";

    if (currentTab === 'admin_term_dates' || currentTab === 'admin_holidays') {
      const nameKey = currentTab === 'admin_term_dates' ? 'Term_Name' : 'Holiday_Name';
      html += `<div class="form-group">
                <label>year</label>
                <input type="text" id="field-year" value="${year}" readonly style="background:#eee;">
              </div>
              <div class="form-group">
                <label>${nameKey.replace('_',' ')}</label>
                <input type="text" id="field-${nameKey}" placeholder="e.g. Term 1">
              </div>
              <div class="form-group">
                <label>Duration (Start to End)</label>
                <input type="text" id="field-Range" placeholder="Select Date Range...">
              </div>
              <div class="form-group">
                <label>Description</label>
                <input type="text" id="field-Description" placeholder="Optional notes...">
              </div>`;
      
      formContent.innerHTML = html;
      
      flatpickr("#field-Range", {
        mode: "range",
        dateFormat: "Y-m-d"
      });
    } else {
      tabData.headers.forEach(h => {
        if (h === 'year') {
          html += `<div class="form-group">
                    <label>${h}</label>
                    <input type="text" id="field-${h}" value="${year}" readonly style="background:#eee;">
                  </div>`;
        } else if (h === 'Value' && currentTab === 'admin_settings') {
          html += `<div class="form-group">
                    <label>${h}</label>
                    <input type="text" id="field-${h}" placeholder="Enter ${h}..." onfocus="detectDateInput(this)">
                  </div>`;
        } else if (h.includes('Date')) {
          html += `<div class="form-group">
                    <label>${h}</label>
                    <input type="date" id="field-${h}">
                  </div>`;
        } else {
          html += `<div class="form-group">
                    <label>${h}</label>
                    <input type="text" id="field-${h}" placeholder="Enter ${h}...">
                  </div>`;
        }
      });
      formContent.innerHTML = html;
    }

    document.getElementById('modal-overlay').style.display = 'flex';
  }

  function detectDateInput(inputEl) {
    const varNameEl = document.getElementById('field-Variable');
    if (!varNameEl) return;
    const varName = varNameEl.value.toUpperCase();
    if (varName.includes('DATE') || varName.includes('START') || varName.includes('END')) {
      inputEl.type = 'date';
    } else {
      inputEl.type = 'text';
    }
  }

  function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
  }

  function submitForm() {
    const tabData = allData[currentTab];
    const payload = {};
    const saveBtn = document.querySelector('.btn-primary[onclick="submitForm()"]');
    
    if (currentTab === 'admin_term_dates' || currentTab === 'admin_holidays') {
      const rangeStr = document.getElementById('field-Range').value;
      if (!rangeStr.includes(" to ")) {
        alert("Please select a valid START and END date on the calendar.");
        return;
      }
      const parts = rangeStr.split(" to ");
      const nameKey = currentTab === 'admin_term_dates' ? 'Term_Name' : 'Holiday_Name';
      
      payload['year'] = document.getElementById('field-year').value;
      payload[nameKey] = document.getElementById(`field-${nameKey}`).value;
      payload['Start_Date'] = parts[0] || "";
      payload['End_Date'] = parts[1] || "";
      payload['Description'] = document.getElementById('field-Description').value;
    } else {
      tabData.headers.forEach(h => {
        payload[h] = document.getElementById(`field-${h}`).value;
      });
    }

    saveBtn.disabled = true;
    const originalText = saveBtn.innerText;
    saveBtn.innerText = "Saving...";

    google.script.run
      .withSuccessHandler(msg => {
        saveBtn.disabled = false;
        saveBtn.innerText = originalText;
        closeModal();
        refreshData();
      })
      .withFailureHandler(err => {
        saveBtn.disabled = false;
        saveBtn.innerText = originalText;
        alert("Server Error: " + err.message);
      })
      .upsertAdminData(currentTab, payload);
  }
</script>
